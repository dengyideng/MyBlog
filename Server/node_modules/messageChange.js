var fs = require('fs'),
    url = require('url'),
    querystring = require('querystring'),
    request = require('request');

exports.messageChange = function(req, res){

    /*var queryStr = url.parse(req.url).query,
        queryParam = querystring.parse(queryStr);
    console.log(queryParam);

    var usersStr = fs.readFileSync(BASE_DIR + '/static/data/user.json');
    var users = JSON.parse(usersStr);
    var mark = false;*/

    var postData = '',
        changeUser = {},
        theUser =  {};
    req.addListener('data', function(postDataChunk){
        postData += postDataChunk;
    });

    req.addListener('end', function(){

        //var paramStr = url.parse(req.url).query;
        //var paramObj = querystring.parse(paramStr);

        //var username = paramObj['username'];
        //var password = paramObj['password'];

        var message = querystring.parse(postData);
        var queryStr = url.parse(req.url).query,
            queryParam = querystring.parse(queryStr);

        var userStr = fs.readFileSync(BASE_DIR + '/static/data/user.json');
        var users = JSON.parse(userStr);
        var mark = false;

        console.log(message);
        for(var x in users.users){
            if(users.users[x].account == queryParam.loginaccount){
                mark = true;

                users.users[x].nickName = (message.nickname != '') ? message.nickname : users.users[x].nickName;
                users.users[x].name = (message.realname != '') ? message.realname : users.users[x].name;
                users.users[x].career = (message.career != '') ? message.career : users.users[x].career;
                users.users[x].birthday = (message.birthday != '') ? message.birthday : users.users[x].birthday;
                users.users[x].introduction = (message.introduction != '') ? message.introduction : users.users[x].introduction;

                if(message.sex == 'boy'){
                    users.users[x].sex = '男';
                }else if(message.sex == 'girl'){
                    users.users[x].sex = '女';
                }else{

                }

                //job
                if(message.job != 0){
                    switch(message.job*1){
                        case 1:
                            users.users[x].job = '电子·微电子';
                            break;
                        case 2:
                            users.users[x].job = '计算机科学与技术';
                            break;
                        case 3:
                            users.users[x].job = '批发零售';
                            break;
                        case 4:
                            users.users[x].job = '贸易·进出口';
                            break;
                        case 5:
                            users.users[x].job = '房地产·建筑与工程';
                            break;
                        case 6:
                            users.users[x].job = '娱乐·运动·休闲';
                            break;
                        case 7:
                            users.users[x].job = '交通·运输·物流';
                            break;
                        case 8:
                            users.users[x].job = '制药·生物工程';
                            break;
                        case 9:
                            users.users[x].job = '互联网·电子商务';
                            break;
                        case 10:
                            users.users[x].job = '其他';
                            break;
                    }
                }

                //region
                var region = "";
                if(message.province != 0 && message.province != undefined){
                    region += message.province;
                    users.users[x].province = message.province;
                    if(message.city != 0 && message.city != undefined){
                        region += message.city;
                        users.users[x].city = message.city;
                        if(message.area != 0 && message.area != undefined){
                            region += message.area;
                            users.users[x].area = message.area;
                        }
                    }

                    console.log(region);
                    users.users[x].region = region;
                }

                fs.writeFileSync(BASE_DIR + '/static/data/user.json', JSON.stringify(users));
                request('http://127.0.0.1:1337/userMessage?loginaccount=' + queryParam.loginaccount, function(err, response, body){
                    if(response.statusCode = 200){
                        //console.log(body);
                     
                        res.writeHead(200, {'Content-Type' : 'text/html'});
                        res.write(body);
                        res.end();
                        console.log("now we are in callback function!");
                    }
                });
                console.log("messageChange success!");
                return;

            }
        }

        if(!mark){
            console.log("can not find this user!");
            return;
        }

    });
};