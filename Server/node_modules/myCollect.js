var fs = require('fs'),
    url = require('url'),
    querystring = require('querystring');

exports.myCollect = function(req, res){
	/*var retHtml = fs.readFileSync(BASE_DIR + '/static/html/index.html');
	console.log("index has already returned!");

	res.writeHead(200, {'Content-Type' : 'text/html'});
    res.write(retHtml);
    res.end();*/
    var params = {
        "blogger" : {
            "account" : 0,
            "photo" : "",
            "nickName" : "",
            "readCount" : 0,
            "blogsCount" : 0,
            "focusedCount" : 0,
            "allBlogsListByCategory" : {
                "web" : 0,
                "java" : 0,
                "cloud" : 0,
                "database" : 0,
                "android" : 0,
                "others" : 0
            }
        },
        "myCollect" : []
    };

    /*{
        "blogId" : 0,
        "title" : ""
    }*/

    var queryStr = url.parse(req.url).query,
        queryParam = querystring.parse(queryStr);

    console.log(queryStr);

    var usersStr = fs.readFileSync(BASE_DIR + '/static/data/user.json');
    var users = JSON.parse(usersStr);
    var blogsStr = fs.readFileSync(BASE_DIR + '/static/data/blog.json');
    var blogs = JSON.parse(blogsStr);
    //var commentStr = fs.readFileSync(BASE_DIR + '/static/data/comment.json');
    //var comment = JSON.parse(commentStr);

    var blogMark = false, userMark = false, 
        blogIndex, userIndex;

    var account = queryParam.loginaccount*1;
    for(var i in users.users){
        if(users.users[i].account == account){
            userMark = true;

            params.blogger.account = users.users[i].account;
            params.blogger.photo = users.users[i].photo;
            params.blogger.nickName = users.users[i].nickName;
            params.blogger.readCount = users.users[i].readCount;
            params.blogger.blogsCount = users.users[i].blogsCount;
            params.blogger.focusedCount = users.users[i].focusedCount;

            for(var j in users.users[i].myCollect){
                for(var x in blogs.blogs){
                    if(blogs.blogs[x].blogId == users.users[i].myCollect[j]){
                        var blogTemp = {};
                        blogTemp.blogId = blogs.blogs[x].blogId;
                        blogTemp.title = blogs.blogs[x].title;

                        params.myCollect.push(blogTemp);
                        break;
                    }
                }
            }
            break;
        }
    }

    if(!userMark){
        console.log("can not find this user!");
        return;
    }

    for(var x in blogs.blogs){
        if(blogs.blogs[x].belong == account){
            switch(blogs.blogs[x].category){
                case 'web':
                    params.blogger.allBlogsListByCategory.web += 1;
                    break;
                case 'android':
                    params.blogger.allBlogsListByCategory.android += 1;
                    break;
                case 'cloud':
                    params.blogger.allBlogsListByCategory.cloud += 1;
                    break;
                case 'java':
                    params.blogger.allBlogsListByCategory.java += 1;
                    break;
                case 'database':
                    params.blogger.allBlogsListByCategory.database += 1;
                    break;
                default:
                    params.blogger.allBlogsListByCategory.others += 1;
            }
        }
    }

    //补齐6个
    for(var i = 0; i < 6; i ++){
        if(params.myCollect[i] == undefined){
            var blogTemp = {};
            blogTemp.blogId = 0;
            blogTemp.title = "";

            params.myCollect.push(blogTemp);
        }
    }

    console.log("myCollect has already returned!");
    //console.log(params.comment.length);
    res.render(BASE_DIR + '/static/template/myCollect.jade', {"params" : params});
};