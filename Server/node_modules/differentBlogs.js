var fs = require('fs'),
    url = require('url'),
    querystring = require('querystring');

exports.differentBlogs = function(req, res){
	/*var retHtml = fs.readFileSync(BASE_DIR + '/static/html/index.html');
	console.log("index has already returned!");

	res.writeHead(200, {'Content-Type' : 'text/html'});
    res.write(retHtml);
    res.end();*/
    var params = {
        "login" : {
            "account" : 0,
            "nickName" : ""
        },
    	"blogs" : [{
            "account" : 0,
    		"photo" : "",
    		"nickName" : "",
            "blogId" : 0,
    		"title" : "",
    		"content" : "",
    		"category" : "",
    		"createTime" : "",
    		"views" : 0
    	},{
            "account" : 0,
    		"photo" : "",
    		"nickName" : "",
            "blogId" : 0,
    		"title" : "",
    		"content" : "",
    		"category" : "",
    		"createTime" : "",
    		"views" : 0
    	},{
            "account" : 0,
    		"photo" : "",
    		"nickName" : "",
            "blogId" : 0,
    		"title" : "",
    		"content" : "",
    		"category" : "",
    		"createTime" : "",
    		"views" : 0
    	},{
            "account" : 0,
    		"photo" : "",
    		"nickName" : "",
            "blogId" : 0,
    		"title" : "",
    		"content" : "",
    		"category" : "",
    		"createTime" : "",
    		"views" : 0
    	},{
            "account" : 0,
    		"photo" : "",
    		"nickName" : "",
            "blogId" : 0,
    		"title" : "",
    		"content" : "",
    		"category" : "",
    		"createTime" : "",
    		"views" : 0
    	}],
    	"count" : 0,
    	"pageCount" : 0,
    	"pages" : [],
    	"chooseIndex" : [],
    	"previous" : -1,
    	"next" : -1,
    	"previousEllipsis" : -1,
    	"nextEllipsis" : -1,
        "listby" : ""
    };

    var queryStr = url.parse(req.url).query,
        queryParam = querystring.parse(queryStr);

    console.log(queryStr);

    var usersStr = fs.readFileSync(BASE_DIR + '/static/data/user.json');
    var users = JSON.parse(usersStr);
    var blogsStr = fs.readFileSync(BASE_DIR + '/static/data/blog.json');
    var blogs = JSON.parse(blogsStr);

    var blogMark, userMark, userIndex,
        blogIndex = [], blogIndexListByViews = [];

    for(var x in blogs.blogs){
        if(blogs.blogs[x].category == queryParam.category){
            blogIndex.push(x);
            blogIndexListByViews.push(x);
        }
    }
    
    
    if(queryParam.listby == 'time' || queryParam.listby == null){
        for(var i = 0; i < 5; i++){
            if(blogIndex[i] != null){
                var account = blogs.blogs[blogIndex[i]].belong,
                    userMark = 0;
                for(var j in users.users){
                    if(users.users[j].account == account){
                        userMark = 1;

                        params.blogs[i].account = users.users[j].account;
                        params.blogs[i].photo = users.users[j].photo;
                        params.blogs[i].nickName = users.users[j].nickName;
                        params.blogs[i].blogId = blogs.blogs[blogIndex[i]].blogId;
                        params.blogs[i].title = blogs.blogs[blogIndex[i]].title;
                        //params.blogs[i].content = blogs.blogs[i].content;
                        params.blogs[i].content = fs.readFileSync(BASE_DIR + '/static/blogs/' + blogs.blogs[blogIndex[i]].content, 'utf8');
                        //console.log(params.blogs[i].content);

                        params.blogs[i].createTime = blogs.blogs[blogIndex[i]].createTime;
                        params.blogs[i].views = blogs.blogs[blogIndex[i]].readCount;
                        switch(blogs.blogs[blogIndex[i]].category){
                            case 'web':
                                params.blogs[i].category = '前端';
                                break;
                            case 'android':
                                params.blogs[i].category = '移动开发';
                                break;
                            case 'cloud':
                                params.blogs[i].category = '云计算';
                                break;
                            case 'java':
                                params.blogs[i].category = 'Java开发';
                                break;
                            case 'database':
                                params.blogs[i].category = '数据库';
                                break;
                            default:
                                params.blogs[i].category = '其他';
                        }
                        break;
                    }
                }
                if(userMark == 0){
                    console.log("can not find this user!");
                    return;
                }
            }else{
                break;
            }
        }

        params.count = blogIndex.length;
        params.pageCount = Math.ceil(blogIndex.length / 5);
        params.pages = [1, 2, 3];
        params.chooseIndex = [1, 0, 0];
        params.listby = 'time';
        /*params.previous = -1;
        params.next = 1;
        params.previousEllipsis = -1;
        params.nextEllipsis = 1;    */

        //添加login信息
        if(queryParam.loginaccount*1 != 0){
            for(var x in users.users){
                if(users.users[x].account == queryParam.loginaccount*1){
                    params.login.account = users.users[x].account;
                    params.login.nickName = users.users[x].nickName;
                    break;
                }
            }
        }

    }else{
        //sort
        console.log("listby views!");
        var blogViews = [];
        for(var x = 0; x < blogIndex.length; x ++){
            blogViews.push(blogs.blogs[blogIndex[x]].readCount);
        }

        for(var i = 0; i < blogViews.length; i ++){
            for(var j = i; j < blogViews.length; j ++){
                if(blogViews[j] > blogViews[i]){
                    var temp1 = blogViews[j];
                    blogViews[j] = blogViews[i];
                    blogViews[i] = temp1;

                    var temp2 = blogIndexListByViews[j];
                    blogIndexListByViews[j] = blogIndexListByViews[i];
                    blogIndexListByViews[i] = temp2;
                }
            }
        }

        for(var i = 0; i < 5; i++){
            if(blogIndexListByViews[i] != null){
                var account = blogs.blogs[blogIndexListByViews[i]].belong,
                    userMark = 0;
                for(var j in users.users){
                    if(users.users[j].account == account){
                        userMark = 1;

                        params.blogs[i].account = users.users[j].account;
                        params.blogs[i].photo = users.users[j].photo;
                        params.blogs[i].nickName = users.users[j].nickName;
                        params.blogs[i].blogId = blogs.blogs[blogIndexListByViews[i]].blogId;
                        params.blogs[i].title = blogs.blogs[blogIndexListByViews[i]].title;
                        //params.blogs[i].content = blogs.blogs[i].content;
                        params.blogs[i].content = fs.readFileSync(BASE_DIR + '/static/blogs/' + blogs.blogs[blogIndexListByViews[i]].content, 'utf8');
                        //console.log(params.blogs[i].content);

                        params.blogs[i].createTime = blogs.blogs[blogIndexListByViews[i]].createTime;
                        params.blogs[i].views = blogs.blogs[blogIndexListByViews[i]].readCount;
                        switch(blogs.blogs[blogIndexListByViews[i]].category){
                            case 'web':
                                params.blogs[i].category = '前端';
                                break;
                            case 'android':
                                params.blogs[i].category = '移动开发';
                                break;
                            case 'cloud':
                                params.blogs[i].category = '云计算';
                                break;
                            case 'java':
                                params.blogs[i].category = 'Java开发';
                                break;
                            case 'database':
                                params.blogs[i].category = '数据库';
                                break;
                            default:
                                params.blogs[i].category = '其他';
                        }
                        break;
                    }
                }
                if(userMark == 0){
                    console.log("can not find this user!");
                    return;
                }
            }else{
                break;
            }
        }

        params.count = blogIndexListByViews.length;
        params.pageCount = Math.ceil(blogIndexListByViews.length/5);
         
        params.pages = [1, 2, 3];
        params.chooseIndex = [1, 0, 0];
        params.listby = 'views';
         
        /*params.previous = -1;
        params.next = 1;
        params.previousEllipsis = -1;
        params.nextEllipsis = 1;    */

        //添加login信息
        if(queryParam.loginaccount*1 != 0){
            for(var x in users.users){
                if(users.users[x].account == queryParam.loginaccount*1){
                    params.login.account = users.users[x].account;
                    params.login.nickName = users.users[x].nickName;
                    break;
                }
            }
        }

    }

    console.log("differentBlogs has already returned!");
    //console.log(params);
    res.render(BASE_DIR + '/static/template/differentBlogs.jade', {"params" : params});
};