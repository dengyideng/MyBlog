var fs = require('fs'),
    url = require('url'),
    http = require('http'),
    querystring = require('querystring'),
    request = require('request');

exports.loginCheck = function(req, res){
	/*var retHtml = fs.readFileSync(BASE_DIR + '/static/html/index.html');
	console.log("index has already returned!");

	res.writeHead(200, {'Content-Type' : 'text/html'});
    res.write(retHtml);
    res.end();*/

    var queryStr = url.parse(req.url).query,
        queryParam = querystring.parse(queryStr);
    console.log(queryParam);

    var usersStr = fs.readFileSync(BASE_DIR + '/static/data/user.json');
    var users = JSON.parse(usersStr);
    var mark = false;

    //errorCode 1:password error; 2:user not find
    for(var x in users.users){
    	if(queryParam.username == users.users[x].account){
    		mark = true;
    		if(queryParam.password == users.users[x].password){
    			console.log("login success!");
    			request('http://127.0.0.1:1337/index?page=1&loginaccount=' + users.users[x].account, function(err, response, body){
    				if(response.statusCode = 200){
    					//console.log(body);
    				 
    					res.writeHead(200, {'Content-Type' : 'text/html'});
                        res.write(body);
                        res.end();
    				    console.log("now we are in callback function!");
    				}
    			});
                console.log("success finally!");
    			return;
    		}

    		console.log("password error!");
    		request('http://127.0.0.1:1337/login?errorcode=1', function(err, response, body){
    			if(response.statusCode = 200){
    				//console.log(body);
    				 
    				res.writeHead(200, {'Content-Type' : 'text/html'});
                    res.write(body);
                    res.end();
    			    console.log("now we are in callback function!");
    			}
    		});

    		return;
    	}
    }

    if(!mark){
    	console.log("can not find this user!");
    	request('http://127.0.0.1:1337/login?errorcode=2', function(err, response, body){
    		if(response.statusCode = 200){
    			//console.log(body);
    				 
    			res.writeHead(200, {'Content-Type' : 'text/html'});
                res.write(body);
                res.end();
    		    console.log("now we are in callback function!");
    		}
    	});

    	return;
    }

    //console.log("login has already returned!");
    //res.render(BASE_DIR + '/static/template/login.jade');
};