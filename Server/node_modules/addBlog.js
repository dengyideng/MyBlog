var fs = require('fs'),
    url = require('url'),
    querystring = require('querystring'),
    formidable = require('formidable'),
    date = require('silly-datetime'),
    request = require('request');

exports.addBlog = function(req, res){
    var postData = '';

    req.addListener('data', function(postDataChunk){
        postData += postDataChunk;
    });

    req.addListener('end', function(){
        //console.log(postData);
        var message = querystring.parse(postData);
        console.log(message);

        var queryStr = url.parse(req.url).query,
            queryParam = querystring.parse(queryStr);

        var userStr = fs.readFileSync(BASE_DIR + '/static/data/user.json');
        var users = JSON.parse(userStr);
        var blogStr = fs.readFileSync(BASE_DIR + '/static/data/blog.json');
        var blogs = JSON.parse(blogStr);
        var mark = false;

        for(var x in users.users){
            if(users.users[x].account == queryParam.loginaccount*1){
                users.users[x].myBlogs.push(blogs.blogs.length + 1);

                var blogTemp = {};
                blogTemp.blogId = blogs.blogs.length + 1;
                blogTemp.belong = users.users[x].account;

                var today = date.format(new Date(), 'YYYY-MM-DD')
                console.log(today);
                blogTemp.createTime = today;
                blogTemp.changeTime = today;
                blogTemp.category = message.category;
                blogTemp.title = message.title;
                blogTemp.content = 'blogArticle' + (blogs.blogs.length + 1) + '.text';

                blogTemp.collectCount = 0;
                blogTemp.readCount = 0;
                console.log(blogTemp);
                blogs.blogs.push(blogTemp);

                fs.writeFile(BASE_DIR + '/static/blogs/blogArticle' + blogs.blogs.length + '.text', message.edit1, function(err){
                    if(err){
                        console.log(err);
                    }
                });

                fs.writeFileSync(BASE_DIR + '/static/data/blog.json', JSON.stringify(blogs));

                fs.writeFileSync(BASE_DIR + '/static/data/user.json', JSON.stringify(users));

                request("http://127.0.0.1:1337/mySpace?loginaccount=" + queryParam.loginaccount, function(err, response, body){
                    if(response.statusCode == 200){
                        console.log("add blog success!");
                     
                        res.writeHead(200, {'Content-Type' : 'text/html'});
                        res.write(body);
                        res.end();
                        //console.log("now we are in callback function!");
                    }
                });

            }
        }

    });
};