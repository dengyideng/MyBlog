var fs = require('fs'),
    url = require('url'),
    http = require('http'),
    querystring = require('querystring'),
    request = require('request');

exports.registerDeal = function(req, res){
    /*var retHtml = fs.readFileSync(BASE_DIR + '/static/html/index.html');
    console.log("index has already returned!");

    res.writeHead(200, {'Content-Type' : 'text/html'});
    res.write(retHtml);
    res.end();*/

    var queryStr = url.parse(req.url).query,
        queryParam = querystring.parse(queryStr);
    console.log(queryParam);

    var usersStr = fs.readFileSync(BASE_DIR + '/static/data/user.json');
    var users = JSON.parse(usersStr);
    var mark = false , newUser = {};

    //errorCode 1:password 6~12位; 2:twice password not same 3:nickName same
    //4:nickName or password empty; 0:success
    if(queryParam.password == '输入密码' || queryParam.username == '输入用户名(昵称)'){
        console.log("nickName or password empty!");
        request("http://127.0.0.1:1337/register?errorcode=4", function(err, response, body){
            if(response.statusCode == 200){
                //console.log(body);
                     
                res.writeHead(200, {'Content-Type' : 'text/html'});
                res.write(body);
                res.end();
                //console.log("now we are in callback function!");
            }
        });
        return;

    }else if(queryParam.password.length < 6 || queryParam.password.length > 12){
        console.log("password length not legal");
        request("http://127.0.0.1:1337/register?errorcode=1", function(err, response, body){
            if(response.statusCode == 200){
                //console.log(body);
                     
                res.writeHead(200, {'Content-Type' : 'text/html'});
                res.write(body);
                res.end();
                console.log("now we are in callback function!");
            }
        });
        return;

    }else if(queryParam.password != queryParam.passwordAgain){
        console.log("twice password not same!");
        request("http://127.0.0.1:1337/register?errorcode=2", function(err, response, body){
            if(response.statusCode == 200){
                //console.log(body);
                     
                res.writeHead(200, {'Content-Type' : 'text/html'});
                res.write(body);
                res.end();
                //console.log("now we are in callback function!");
            }
        });
        return;

    }else{
        for(var x in users.users){
            if(users.users[x].nickName == queryParam.username){
                console.log("this nickName has already exist!");
                request("http://127.0.0.1:1337/register?errorcode=3", function(err, response, body){
                    if(response.statusCode == 200){
                        //console.log(body);
                     
                        res.writeHead(200, {'Content-Type' : 'text/html'});
                        res.write(body);
                        res.end();
                        //console.log("now we are in callback function!");
                    }
                });
                return;
            }
        }

        //add new user
        newUser.account = users.users.length + 1001;
        newUser.nickName = queryParam.username;
        newUser.name = "";
        newUser.photo = "/picture/picture14.jpg";  //默认头像
        newUser.sex = "";
        newUser.birthday = "";
        newUser.password = queryParam.password;
        newUser.career = "";
        newUser.job = "";
        newUser.region = "";
        newUser.province = "";
        newUser.city = "";
        newUser.area = "";
        newUser.introduction = "";
        newUser.readCount = 0;
        newUser.blogsCount = 0;
        newUser.focusedCount = 0;
        newUser.myCollect = [];
        newUser.myFocus = [];
        newUser.myBlogs = [];

        users.users.push(newUser);

        fs.writeFile(BASE_DIR + '/static/data/user.json', JSON.stringify(users), function(err){
            if(err){
                console.log(err);
                return;
            }else{
                console.log("newUser has been added into database already!");
            }
        });

        if(queryParam.loginOption == null){
            console.log("register success!");
            request('http://127.0.0.1:1337/register?loginaccount=0&account=' + newUser.account, function(err, response, body){
                if(response.statusCode == 200){
                    //console.log(body);
                     
                    res.writeHead(200, {'Content-Type' : 'text/html'});
                    res.write(body);
                    res.end();
                    //console.log("now we are in callback function!");
                }
            });
            return;

        }else{
            console.log("register success!");
            request('http://127.0.0.1:1337/register?loginaccount=' + newUser.account + '&account=' + newUser.account, function(err, response, body){
                if(response.statusCode == 200){
                    //console.log(body);
                     
                    res.writeHead(200, {'Content-Type' : 'text/html'});
                    res.write(body);
                    res.end();
                    //console.log("now we are in callback function!");
                }
            });
            return;
        }
    }
};