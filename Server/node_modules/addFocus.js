var fs = require('fs'),
    url = require('url'),
    querystring = require('querystring'),
    request = require('request');

exports.addFocus = function(req, res){
	/*var retHtml = fs.readFileSync(BASE_DIR + '/static/html/index.html');
	console.log("index has already returned!");

	res.writeHead(200, {'Content-Type' : 'text/html'});
    res.write(retHtml);
    res.end();*/

    var queryStr = url.parse(req.url).query,
        queryParam = querystring.parse(queryStr);
    console.log(queryParam);

    var usersStr = fs.readFileSync(BASE_DIR + '/static/data/user.json');
    var users = JSON.parse(usersStr);
    var mark = false, sameMark = false;

    if(queryParam.loginaccount*1 == 0){
        console.log("please login first!");
        request("http://127.0.0.1:1337/login", function(err, response, body){
            if(response.statusCode == 200){
                //console.log(body);
                     
                res.writeHead(200, {'Content-Type' : 'text/html'});
                res.write(body);
                res.end();
            }
        });
        return;

    }else{
        //statuscode: 0: fail, 1: success, 2: can not focus one person twice
        //3: can not focus yourself
        var statusCode = 0;
        for(var x in users.users){
            if(users.users[x].account == queryParam.loginaccount*1){
                mark = true;
                //users.users[x].myFocus.push(queryParam.focusAccount*1);
                //console.log("addFocus success!");
                if(queryParam.focusAccount != queryParam.loginaccount){
                    for(var i in users.users[x].myFocus){
                        if(users.users[x].myFocus[i] == queryParam.focusAccount){
                            sameMark = true;
                            statusCode = 2;
                            break;
                        }
                    }

                    if(!sameMark){
                        statusCode = 1;
                        console.log(queryParam.focusAccount*1);
                        users.users[x].myFocus.push(queryParam.focusAccount*1);
                        fs.writeFileSync(BASE_DIR + '/static/data/user.json', JSON.stringify(users));
                        console.log("addFocus success!");

                    }
                }else{
                    statusCode = 3;

                }

                if(queryParam.requestPage == 'blogsShow'){
                    if(queryParam.blogid != null){
                        console.log("now we are in blogsShow with blogid!");
                        request("http://127.0.0.1:1337/blogsShow?loginaccount=" + queryParam.loginaccount + "&statuscode=" + statusCode + "&blogid=" + queryParam.blogid, function(err, response, body){
                            if(response.statusCode == 200){
                                //console.log(body);
                     
                                res.writeHead(200, {'Content-Type' : 'text/html'});
                                res.write(body);
                                res.end();
                            }
                        });
                        return;

                    }else if(queryParam.category == null){
                        console.log("now we are in blogsShow without category!");
                        request("http://127.0.0.1:1337/blogsShow?loginaccount=" + queryParam.loginaccount + "&statuscode=" + statusCode + "&account=" + queryParam.account, function(err, response, body){
                            if(response.statusCode == 200){
                                //console.log(body);
                     
                                res.writeHead(200, {'Content-Type' : 'text/html'});
                                res.write(body);
                                res.end();
                            }
                        });
                        return;

                    }else{
                        console.log("now we are in blogsShow with account and category!");
                        request("http://127.0.0.1:1337/blogsShow?loginaccount=" + queryParam.loginaccount + "&statuscode=" + statusCode + "&account=" + queryParam.account + "&category=" + queryParam.category, function(err, response, body){
                            if(response.statusCode == 200){
                                //console.log(body);
                     
                                res.writeHead(200, {'Content-Type' : 'text/html'});
                                res.write(body);
                                res.end();
                            }
                        });
                        return;

                    }

                }else if(queryParam.requestPage == 'blogExperts'){
                    console.log("now we are in blogExperts!");
                    request("http://127.0.0.1:1337/blogExperts?loginaccount=" + queryParam.loginaccount + "&statuscode=" + statusCode, function(err, response, body){
                        if(response.statusCode == 200){
                            //console.log(body);
                     
                            res.writeHead(200, {'Content-Type' : 'text/html'});
                            res.write(body);
                            res.end();
                        }
                    });
                    return;

                }
            }
        }

        if(!mark){
            console.log("can not find this user!");
            return;
        }

    }

};